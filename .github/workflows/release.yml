name: Release

on:
  push:
    branches:
      - main
env:
  CI: true
  NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
  PNPM_CACHE_FOLDER: .pnpm-store
  PKG_RELEASE_KEY: lastReleaseCommit
jobs:
  release:
    # prevents this action from running on forks
    if: github.repository == 'Marinerer/jotter'
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: checkout code repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: CI:test
        run: |
          pnpm test domEmit emitter -- --coverage

      - name: CI:build
        run: pnpm build --clean

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      # ä»Ž package.json ä¸­è¯»å–æœ€åŽå‘å¸ƒ commit
      - name: ðŸ“ Get release commit from package.json ðŸ”‘
        id: get_pkg_release
        run: |
          #ä½¿ç”¨ jq å·¥å…·è§£æžjson, é»˜è®¤å·²å†…ç½®. 
          PKG_RELEASE=$(jq -r '.lastReleaseCommit' package.json)
          echo "Package Release: $PKG_RELEASE"
          echo "PKG_RELEASE_COMMIT=$PKG_RELEASE" >> $GITHUB_ENV

      # èŽ·å–æœ€åŽä¸€æ¡ä»¥'release:'å¼€å¤´çš„æäº¤è®°å½•çš„å“ˆå¸Œå€¼
      - name: ðŸ“ Get last release commit ðŸ”’
        id: get_last_release
        run: |
          # èŽ·å–æœ€åŽä¸€æ¡ä»¥ 'release: ' å¼€å¤´çš„æäº¤è®°å½•çš„å“ˆå¸Œå€¼
          LAST_RELEASE=$(git log --grep='^release: ' --format='%H' -n 1)

          if [ -z "$LAST_RELEASE" ]; then
            echo "No release commit found."
            exit 1  # å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ä¸ºè·³è¿‡æˆ–å¤±è´¥
          fi

          echo "Last release commit: $LAST_RELEASE"
          echo "LAST_RELEASE_COMMIT=$LAST_RELEASE" >> $GITHUB_ENV

      - name: Create Release Pull Request or Publish to npm ðŸ”
        # å¦‚æžœæœ‰æ–°çš„ `release: ` æäº¤è®°å½•, åˆ™æ‰§è¡Œå‘å¸ƒ
        if: env.LAST_RELEASE_COMMIT != env.PKG_RELEASE_COMMIT
        id: changesets
        uses: changesets/action@v1
        with:
          # This expects you to have a script called release which does a build for your packages and calls changeset publish
          # Custom versioning script in package.json
          # version: pnpm changeset:version
          # Custom publish script in package.json
          publish: pnpm changeset:release
          # Messages
          commit: 'chore(deploy): Release'
          title: 'chore(deploy): Release'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

      - name: ðŸš¦(Package.json) - Change ðŸ‘·
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "Update package.json..."
          echo "LAST_RELEASE_COMMIT: $LAST_RELEASE_COMMIT"
          #ä½¿ç”¨ jq æ›¿æ¢æœ€åŽå‘å¸ƒcommitå€¼
          jq ".lastReleaseCommit = \"$LAST_RELEASE_COMMIT\"" package.json > _temp_.json && mv _temp_.json package.json
      - name: ðŸš¦(Package.json) - Commit ðŸš€
        if: steps.changesets.outputs.published == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: Update last_release_commit(package.json)"
          git push
